name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para executar os testes'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - homolog
          - prod

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Instalar dependÃªncias
      run: npm install

    - name: Instalar browsers do Playwright
      run: npx playwright install --with-deps ${{ matrix.browser }}

    - name: Criar arquivo .env para ambiente DEV
      if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == ''
      run: |
        echo "BASE_URL=${{ secrets.DEV_BASE_URL }}" > .env.dev
        echo "USERNAME=${{ secrets.DEV_USERNAME }}" >> .env.dev
        echo "PASSWORD=${{ secrets.DEV_PASSWORD }}" >> .env.dev
        echo "ACTION_TIMEOUT=10000" >> .env.dev
        echo "NAVIGATION_TIMEOUT=30000" >> .env.dev

    - name: Criar arquivo .env para ambiente HOMOLOG
      if: github.event.inputs.environment == 'homolog'
      run: |
        echo "BASE_URL=${{ secrets.HOMOLOG_BASE_URL }}" > .env.homolog
        echo "USERNAME=${{ secrets.HOMOLOG_USERNAME }}" >> .env.homolog
        echo "PASSWORD=${{ secrets.HOMOLOG_PASSWORD }}" >> .env.homolog
        echo "ACTION_TIMEOUT=10000" >> .env.homolog
        echo "NAVIGATION_TIMEOUT=30000" >> .env.homolog

    - name: Criar arquivo .env para ambiente PROD
      if: github.event.inputs.environment == 'prod'
      run: |
        echo "BASE_URL=${{ secrets.PROD_BASE_URL }}" > .env.prod
        echo "USERNAME=${{ secrets.PROD_USERNAME }}" >> .env.prod
        echo "PASSWORD=${{ secrets.PROD_PASSWORD }}" >> .env.prod
        echo "ACTION_TIMEOUT=10000" >> .env.prod
        echo "NAVIGATION_TIMEOUT=30000" >> .env.prod

    - name: Executar testes Playwright (DEV)
      if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == ''
      run: npm run test:dev -- --project=${{ matrix.browser }}
      continue-on-error: true

    - name: Executar testes Playwright (HOMOLOG)
      if: github.event.inputs.environment == 'homolog'
      run: npm run test:homolog -- --project=${{ matrix.browser }}
      continue-on-error: true

    - name: Executar testes Playwright (PROD)
      if: github.event.inputs.environment == 'prod'
      run: npm run test:prod -- --project=${{ matrix.browser }}
      continue-on-error: true

    - name: Upload dos relatÃ³rios HTML
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}-${{ github.event.inputs.environment || 'dev' }}
        path: playwright-report-*
        retention-days: 30

    - name: Upload dos resultados JSON
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}-${{ github.event.inputs.environment || 'dev' }}
        path: test-results/
        retention-days: 30

    - name: Upload de screenshots e vÃ­deos de falhas
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-failures-${{ matrix.browser }}-${{ github.event.inputs.environment || 'dev' }}
        path: test-results/
        retention-days: 30

  consolidate-results:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Baixar todos os artefatos
      uses: actions/download-artifact@v4
      with:
        path: all-reports

    - name: Consolidar relatÃ³rios
      run: |
        echo "## ðŸ“Š Resumo dos Testes Playwright" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ambiente:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Browsers testados:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Chromium" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Firefox" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… WebKit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ RelatÃ³rios disponÃ­veis nos artefatos desta execuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
