name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para executar os testes'
        required: true
        default: 'homolog'
        type: choice
        options:
          - dev
          - homolog
          - prod
      test_file:
        description: 'Arquivo de teste espec√≠fico (opcional, ex: tests/auth.spec.ts)'
        required: false
        default: ''
        type: string

jobs:
  test:
    timeout-minutes: 60
    runs-on: self-hosted
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Instalar depend√™ncias
      run: npm install

    - name: Criar arquivo .env para ambiente HOMOLOG (padr√£o em push autom√°tico)
      if: github.event.inputs.environment == 'homolog' || github.event.inputs.environment == ''
      run: |
        echo "ENVIRONMENT=homolog" > .env.homolog
        echo "HOMOLOG_BASE_URL=${{ secrets.HOMOLOG_BASE_URL }}" >> .env.homolog
        echo "HOMOLOG_USERNAME=${{ secrets.HOMOLOG_USERNAME }}" >> .env.homolog
        echo "HOMOLOG_PASSWORD=${{ secrets.HOMOLOG_PASSWORD }}" >> .env.homolog
        echo "ACTION_TIMEOUT=30000" >> .env.homolog
        echo "NAVIGATION_TIMEOUT=60000" >> .env.homolog

    - name: Debug - Verificar conectividade com servidor HOMOLOG
      if: github.event.inputs.environment == 'homolog' || github.event.inputs.environment == ''
      run: |
        echo "üîç Testando conectividade com servidor HOMOLOG..."
        echo "URL: ${{ secrets.HOMOLOG_BASE_URL }}"
        curl -I --connect-timeout 10 --max-time 15 ${{ secrets.HOMOLOG_BASE_URL }} || echo "‚ùå Servidor n√£o acess√≠vel"

    - name: Criar arquivo .env para ambiente DEV
      if: github.event.inputs.environment == 'dev'
      run: |
        echo "ENVIRONMENT=dev" > .env.dev
        echo "DEV_BASE_URL=${{ secrets.DEV_BASE_URL }}" >> .env.dev
        echo "DEV_USERNAME=${{ secrets.DEV_USERNAME }}" >> .env.dev
        echo "DEV_PASSWORD=${{ secrets.DEV_PASSWORD }}" >> .env.dev
        echo "ACTION_TIMEOUT=30000" >> .env.dev
        echo "NAVIGATION_TIMEOUT=60000" >> .env.dev

    - name: Debug - Verificar conectividade com servidor DEV
      if: github.event.inputs.environment == 'dev'
      run: |
        echo "üîç Testando conectividade com servidor DEV..."
        echo "URL: ${{ secrets.DEV_BASE_URL }}"
        curl -I --connect-timeout 10 --max-time 15 ${{ secrets.DEV_BASE_URL }} || echo "‚ùå Servidor n√£o acess√≠vel"

    - name: Criar arquivo .env para ambiente PROD
      if: github.event.inputs.environment == 'prod'
      run: |
        echo "ENVIRONMENT=prod" > .env.prod
        echo "PROD_BASE_URL=${{ secrets.PROD_BASE_URL }}" >> .env.prod
        echo "PROD_USERNAME=${{ secrets.PROD_USERNAME }}" >> .env.prod
        echo "PROD_PASSWORD=${{ secrets.PROD_PASSWORD }}" >> .env.prod
        echo "ACTION_TIMEOUT=30000" >> .env.prod
        echo "NAVIGATION_TIMEOUT=60000" >> .env.prod

    - name: Debug - Verificar conectividade com servidor PROD
      if: github.event.inputs.environment == 'prod'
      run: |
        echo "üîç Testando conectividade com servidor PROD..."
        echo "URL: ${{ secrets.PROD_BASE_URL }}"
        curl -I --connect-timeout 10 --max-time 15 ${{ secrets.PROD_BASE_URL }} || echo "‚ùå Servidor n√£o acess√≠vel"

    - name: Executar testes Playwright (HOMOLOG - padr√£o)
      if: github.event.inputs.environment == 'homolog' || github.event.inputs.environment == ''
      run: npm run test:homolog -- --project=${{ matrix.browser }} ${{ github.event.inputs.test_file }}
      continue-on-error: true

    - name: Executar testes Playwright (DEV)
      if: github.event.inputs.environment == 'dev'
      run: npm run test:dev -- --project=${{ matrix.browser }} ${{ github.event.inputs.test_file }}
      continue-on-error: true

    - name: Executar testes Playwright (PROD)
      if: github.event.inputs.environment == 'prod'
      run: npm run test:prod -- --project=${{ matrix.browser }} ${{ github.event.inputs.test_file }}
      continue-on-error: true

    - name: Gerar relat√≥rio customizado
      if: always()
      run: npm run report:custom custom-report-${{ github.event.inputs.environment || 'homolog' }}
      continue-on-error: true

    - name: Upload do relat√≥rio customizado
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: custom-report-${{ matrix.browser }}-${{ github.event.inputs.environment || 'homolog' }}
        path: custom-report-${{ github.event.inputs.environment || 'homolog' }}/
        retention-days: 30

    - name: Upload dos relat√≥rios HTML
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}-${{ github.event.inputs.environment || 'homolog' }}
        path: playwright-report-*
        retention-days: 30

    - name: Upload dos resultados JSON
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}-${{ github.event.inputs.environment || 'homolog' }}
        path: test-results/
        retention-days: 30

    - name: Upload de screenshots e v√≠deos de falhas
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-failures-${{ matrix.browser }}-${{ github.event.inputs.environment || 'homolog' }}
        path: test-results/
        retention-days: 30

  consolidate-results:
    needs: test
    runs-on: self-hosted
    if: always()
    
    steps:
    - name: Baixar todos os artefatos
      uses: actions/download-artifact@v4
      with:
        path: all-reports

    - name: Consolidar relat√≥rios
      run: |
        echo "## üìä Resumo dos Testes Playwright" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ambiente:** ${{ github.event.inputs.environment || 'homolog' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Browsers testados:" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Chromium" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Firefox" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ WebKit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìÅ Relat√≥rios dispon√≠veis nos artefatos desta execu√ß√£o:" >> $GITHUB_STEP_SUMMARY
        echo "- üé≠ Relat√≥rio Playwright (HTML interativo)" >> $GITHUB_STEP_SUMMARY
        echo "- üìä Relat√≥rio Customizado (Dashboard)" >> $GITHUB_STEP_SUMMARY
        echo "- üìÑ Resultados JSON" >> $GITHUB_STEP_SUMMARY

  publish-pages:
    needs: consolidate-results
    runs-on: self-hosted
    if: always()
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Limpar pasta docs
        run: rm -rf docs/*


      - name: Baixar relat√≥rio customizado do Chromium
        uses: actions/download-artifact@v4
        with:
          name: custom-report-chromium-${{ github.event.inputs.environment || 'homolog' }}
          path: docs/

      - name: Garantir index.html na raiz de docs
        run: |
          if [ -d "docs/custom-report-homolog" ]; then
            mv docs/custom-report-homolog/index.html docs/index.html
          fi

      - name: Commit e push do relat√≥rio para docs
        env:
          GH_PAGES_TOKEN: ${{ secrets.GH_PAGES_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git commit -m "docs: publicar relat√≥rio customizado no GitHub Pages [skip ci]" || echo "Nada para commitar"
          git push https://x-access-token:${GH_PAGES_TOKEN}@github.com/OrquestraIA/TestsDoc-Simples.git main
